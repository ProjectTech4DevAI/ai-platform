import os
from pathlib import Path
from urllib.parse import urlparse

import pytest
from unittest.mock import patch
from botocore.exceptions import ClientError
from moto import mock_aws
from sqlmodel import Session, select

from openai import OpenAI
import openai_responses
from openai_responses import OpenAIMock

from app.core.cloud import AmazonCloudStorageClient
from app.core.config import settings
from app.models import Document
from app.tests.utils.document import (
    DocumentStore,
    DocumentMaker,
    Route,
    WebCrawler,
    crawler,
)
from app.tests.utils.utils import openai_credentials
from app.seed_data.seed_data import seed_database


@pytest.fixture
def route():
    return Route("remove")


@pytest.fixture(scope="function", autouse=True)
def load_seed_data(db):
    """Load seed data before each test."""
    seed_database(db)
    yield


@pytest.fixture(scope="class")
def aws_credentials():
    os.environ["AWS_ACCESS_KEY_ID"] = "testing"
    os.environ["AWS_SECRET_ACCESS_KEY"] = "testing"
    os.environ["AWS_SECURITY_TOKEN"] = "testing"
    os.environ["AWS_SESSION_TOKEN"] = "testing"
    os.environ["AWS_DEFAULT_REGION"] = settings.AWS_DEFAULT_REGION


@pytest.mark.usefixtures("openai_credentials")
@mock_aws
class TestDocumentRouteRemove:
    @openai_responses.mock()
    @patch("app.api.routes.documents.get_provider_credential")
    @patch("app.api.routes.documents.configure_openai")
    def test_item_is_soft_removed(
        self,
        mock_configure_openai,
        mock_get_credential,
        db: Session,
        route: Route,
        crawler: WebCrawler,
    ):
        openai_mock = OpenAIMock()
        with openai_mock.router:
            client = OpenAI(api_key="test_key")
            mock_get_credential.return_value = {"api_key": "sk-test-key"}
            mock_configure_openai.return_value = (client, True)

        # Setup AWS
        aws = AmazonCloudStorageClient()
        aws.create()

        # Setup document in DB and S3
        store = DocumentStore(db)
        document = store.put()
        s3_key = Path(urlparse(document.object_store_url).path).relative_to("/")
        aws.client.put_object(
            Bucket=settings.AWS_S3_BUCKET, Key=str(s3_key), Body=b"test"
        )

        # Delete document
        response = crawler.delete(route.append(document, suffix="permanent"))
        print(response)
        assert response.is_success

        db.refresh(document)

        stmt = select(Document).where(Document.id == document.id)
        doc_in_db = db.exec(stmt).first()
        assert doc_in_db is not None
        assert doc_in_db.deleted_at is not None

        with pytest.raises(ClientError) as exc_info:
            aws.client.head_object(
                Bucket=settings.AWS_S3_BUCKET,
                Key=str(s3_key),
            )
        assert exc_info.value.response["Error"]["Code"] == "404"

    @openai_responses.mock()
    def test_cannot_delete_nonexistent_document(
        self,
        db: Session,
        route: Route,
        crawler: WebCrawler,
    ):
        DocumentStore.clear(db)

        maker = DocumentMaker(db)
        response = crawler.delete(route.append(next(maker), suffix="permanent"))

        assert response.is_error
